<link rel="import" href="../polymer/polymer.html">

<dom-module id="simple-callout">
  <template>
    <style>
      :host, *, *::before, *::after {
        box-sizing: border-box;
      }

      /**
       * Core
       */
      :host {
        position: relative;
        display: inline-block;
        will-change: transform;
        background: white;
        border-radius: 3px;
        outline: none;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
                    0 1px 5px 0 rgba(0, 0, 0, 0.12),
                    0 3px 1px -2px rgba(0, 0, 0, 0.2);
        -moz-osx-font-smoothing: grayscale;
         -webkit-font-smoothing: antialiased;
                 font-smoothing: antialiased;
      }

      :host(:not([active])) {
        display: none;
      }

      :host(:not([visible])) {
        transform: scale(0.75, 0.85);
        opacity: 0;
        transition: transform 125ms cubic-bezier(0.4, 0.0, 1, 1),
                    opacity 90ms ease;
      }

      :host([visible]) {
        opacity: 1;
        transform: scale(1);
        transition: transform 150ms cubic-bezier(0.0, 0.0, 0.2, 1),
                    opacity 100ms ease;
      }

      /**
       * Arrow
       */
      :host([arrow])::before {
        content: '';
        position: absolute;
        height: var(--simple-callout-arrow-size, 8px);
        width: var(--simple-callout-arrow-size, 8px);
        transform: rotate(45deg);
        background: inherit;
      }

      /* Make sure content is on top of arrow */
      :host([arrow]) ::content * {
        position: relative;
        z-index: 1;
      }

      /**
       * Arrow positioning
       */
      /* Top */
      :host([arrow][origin*="top"])::before {
        top: calc(0px - var(--simple-callout-arrow-size, 8px) / 2);
        box-shadow: -1px -1px rgba(0,0,0, 0.075);
        border-top-left-radius: 2px;
      }

      /* Bottom */
      :host([arrow][origin*="bottom"])::before {
        bottom: calc(0px - var(--simple-callout-arrow-size, 8px) / 2);
        box-shadow: 1px 1px 1px rgba(0,0,0, 0.2);
        border-bottom-right-radius: 2px;
      }

       /* Top/bottom Left */
      :host([arrow][origin*="left"])::before {
        left: var(--simple-callout-arrow-size, 8px);
      }

      :host([arrow][origin*="center"])::before {
        left: calc(50% - var(--simple-callout-arrow-size, 8px) / 2);
      }

      :host([arrow][origin*="right"])::before {
        right: var(--simple-callout-arrow-size, 8px);
      }

      /* Left side */
      :host([arrow][origin="left"])::before {
        top: calc(50% - var(--simple-callout-arrow-size, 8px) / 2);
        left: calc(0px - var(--simple-callout-arrow-size, 8px) / 2);
        box-shadow: -1px 1px 1px rgba(0,0,0, 0.075);
        border-bottom-left-radius: 2px;
      }

      /* Right side */
      :host([arrow][origin="right"])::before {
        top: calc(50% - var(--simple-callout-arrow-size, 8px) / 2);
        right: calc(0px - var(--simple-callout-arrow-size, 8px) / 2);
        box-shadow: 1px -1px 0 rgba(0,0,0, 0.075);
        border-top-right-radius: 2px;
      }
    </style>

    <content></content>

  </template>
  <script>
    class SimpleCallout {
      beforeRegister() {
        this.is = 'simple-callout',

        this.properties = {

          /**
           * State of callout
           * @type {Boolean}
           */
          active: {
            type: Boolean,
            reflectToAttribute: true,
            readonly: true,
            notify: true
          },

          /**
           * If callout is visible
           * @type {Boolean}
           */
          visible: {
            type: Boolean,
            reflectToAttribute: true,
            readonly: true
          },

          /**
           * Disable closing when focus lost
           * @type {Boolean}
           */
          noBlur: Boolean,

          /**
           * Disable closing when user presses escape key
           * @type {Boolean}
           */
          noEscape: Boolean,

          /**
          * Where the callout expands from, space-separated list
          * (top/bottom) (left/center|right) || left/right
          * @type {String}
          */
          origin: {
            type: String,
            reflectToAttribute: true,
            observer: '_setTransformOrigin'
          },

          /**
           * Whether the callout should have an arrow
           * @type {Object}
           */
          arrow: {
            type: Boolean,
            reflectToAttribute: true
          },

          tabindex: {
            type: Number,
            reflectToAttribute: true,
            readonly: true,
            value: 0
          }

        };

        this.observers = [
          '_focusOnActive(active)',
          '_goVisibleOnActive(active)',
          '_closeOnEscape(active)'
        ];

        this.listeners = {
          blur: '_closeOnBlur',
          transitionend: '_goInactiveOnClose'
        };
      }

      open() {
        this.active = true;
      }

      close() {
        this.visible = false;
      }

      toggle() {
        if (!this.active) {
          this.open();
        } else {
          this.close();
        }
      }

      _focusOnActive(active) {
        if (active) {
          this.focus();
        }
      }

      _goVisibleOnActive(active) {
        if (active) {
          Polymer.RenderStatus
            .afterNextRender(this, () => this.visible = true);
        }
      }

      _goInactiveOnClose(e) {
        if (!this.visible) {
          this.active = false;
        }
      }

      _closeOnBlur(e) {
        if (!this.noBlur) {
          this.visible = false;
        }
      }

      _closeOnEscape(active) {
        let closeIfEscape = (e) => {
          if (!this.noEscape && e.keyCode === 27) {
            this.active = false;
          }
        };

        if (active) {
          document.addEventListener('keydown', closeIfEscape);
        } else {
          document.removeEventListener('keydown', closeIfEscape);
        }
      }

      /**
       * Set transform origin based on origin
       * @param {String} origin Current value of arrow property
       * @returns {undefined}
       */
      _setTransformOrigin(origin) {
        if (!origin) {
          return;
        }

        this.style['transform-origin'] = origin;
      }

    };
    Polymer(SimpleCallout)
  </script>
</dom-module>
